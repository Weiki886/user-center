import{m as $,f as k,n as z,w as t,b as e,c as N,h as Y,P as Z,p as T,i as c,r as d,s as ee,a as p,j as g,v as ae,x as te,y as se,u as le,o as re,z as oe,k as j,t as V,g as E,A as ne,B as ue}from"./index-CrxnEdR7.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const de=["src"],ie={key:1,class:"avatar-uploader"},ve={__name:"UserDialog",props:{visible:{type:Boolean,default:!1},userData:{type:Object,default:null}},emits:["update:visible","success"],setup(O,{emit:x}){const y=O,C=x,w=g(!1);$(()=>y.visible,u=>{w.value=u}),$(w,u=>{C("update:visible",u)});const I=g(null),f=g(!1),P=g(!1),l=g({username:"",userAccount:"",userPassword:"",checkPassword:"",gender:0,phone:"",email:"",avatarUrl:""}),v={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在2-20之间",trigger:"blur"}],userAccount:[{required:!0,message:"请输入账号",trigger:"blur"},{min:4,max:20,message:"账号长度在4-20之间",trigger:"blur"}],userPassword:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:20,message:"密码长度在6-20之间",trigger:"blur"}],checkPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(u,s,U)=>{s!==l.value.userPassword?U(new Error("两次输入的密码不一致")):U()},trigger:"blur"}]},i=ae(()=>{var u;return!!((u=y.userData)!=null&&u.id)});$(()=>[w.value,y.userData],([u,s])=>{u&&(s&&s.id?l.value={...s}:l.value={username:"",userAccount:"",userPassword:"",checkPassword:"",gender:0,phone:"",email:"",avatarUrl:""})},{immediate:!0});const D=u=>{const s=u.type.startsWith("image/"),U=u.size/1024/1024<10;if(!s)return p.error("只能上传图片文件!"),!1;if(!U)return p.error("头像大小不能超过 10MB!"),!1;const r=new FileReader;return r.onload=a=>{l.value.avatarUrl=a.target.result},r.readAsDataURL(u),!1},q=async u=>{var m;const{file:s,onSuccess:U,onError:r}=u,a=(m=y.userData)==null?void 0:m.id;if(!a){U({data:l.value.avatarUrl});return}try{P.value=!0;const _=await ee(a,s);_.data&&(l.value.avatarUrl=_.data),U(_),p.success("头像上传成功")}catch(_){r(_),p.error(_.message||"头像上传失败")}finally{P.value=!1}},b=()=>{w.value=!1,setTimeout(()=>{var u;(u=I.value)==null||u.resetFields(),l.value={username:"",userAccount:"",gender:0,phone:"",email:"",avatarUrl:""}},100)},B=async()=>{await I.value.validate(),f.value=!0;try{i.value?(await te(y.userData.id,l.value),p.success("更新成功")):(await se({username:l.value.username,userAccount:l.value.userAccount,userPassword:l.value.userPassword,checkPassword:l.value.checkPassword,gender:l.value.gender,phone:l.value.phone,email:l.value.email,avatarUrl:l.value.avatarUrl}),p.success("新增成功")),C("success"),b()}catch(u){p.error(u.message||"操作失败")}finally{f.value=!1}};return(u,s)=>{const U=d("a-upload"),r=d("a-form-item"),a=d("a-input"),m=d("a-input-password"),_=d("a-radio"),h=d("a-radio-group"),L=d("a-form"),A=d("a-button"),R=d("a-modal");return k(),z(R,{open:w.value,"onUpdate:open":s[7]||(s[7]=n=>w.value=n),title:i.value?"编辑用户":"新增用户",width:"600px",closable:!1,onCancel:b},{footer:t(()=>[e(A,{onClick:b},{default:t(()=>[...s[11]||(s[11]=[c("取消",-1)])]),_:1}),e(A,{type:"primary",loading:f.value,onClick:B},{default:t(()=>[...s[12]||(s[12]=[c("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(L,{model:l.value,rules:v,ref_key:"formRef",ref:I,layout:"vertical"},{default:t(()=>[e(r,{label:"头像"},{default:t(()=>[e(U,{"list-type":"picture-card","show-upload-list":!1,"before-upload":D,"custom-request":q},{default:t(()=>[l.value.avatarUrl?(k(),N("img",{key:0,src:l.value.avatarUrl,class:"avatar"},null,8,de)):(k(),N("div",ie,[e(Y(Z))]))]),_:1})]),_:1}),e(r,{label:"用户名",name:"username"},{default:t(()=>[e(a,{value:l.value.username,"onUpdate:value":s[0]||(s[0]=n=>l.value.username=n),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),e(r,{label:"账号",name:"userAccount"},{default:t(()=>[e(a,{value:l.value.userAccount,"onUpdate:value":s[1]||(s[1]=n=>l.value.userAccount=n),placeholder:"请输入账号",disabled:i.value},null,8,["value","disabled"])]),_:1}),i.value?T("",!0):(k(),z(r,{key:0,label:"密码",name:"userPassword"},{default:t(()=>[e(m,{value:l.value.userPassword,"onUpdate:value":s[2]||(s[2]=n=>l.value.userPassword=n),placeholder:"请输入密码"},null,8,["value"])]),_:1})),i.value?T("",!0):(k(),z(r,{key:1,label:"确认密码",name:"checkPassword"},{default:t(()=>[e(m,{value:l.value.checkPassword,"onUpdate:value":s[3]||(s[3]=n=>l.value.checkPassword=n),placeholder:"请确认密码"},null,8,["value"])]),_:1})),e(r,{label:"性别",name:"gender"},{default:t(()=>[e(h,{value:l.value.gender,"onUpdate:value":s[4]||(s[4]=n=>l.value.gender=n)},{default:t(()=>[e(_,{value:0},{default:t(()=>[...s[8]||(s[8]=[c("未知",-1)])]),_:1}),e(_,{value:1},{default:t(()=>[...s[9]||(s[9]=[c("男",-1)])]),_:1}),e(_,{value:2},{default:t(()=>[...s[10]||(s[10]=[c("女",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),e(r,{label:"电话",name:"phone"},{default:t(()=>[e(a,{value:l.value.phone,"onUpdate:value":s[5]||(s[5]=n=>l.value.phone=n),placeholder:"请输入电话"},null,8,["value"])]),_:1}),e(r,{label:"邮箱",name:"email"},{default:t(()=>[e(a,{value:l.value.email,"onUpdate:value":s[6]||(s[6]=n=>l.value.email=n),placeholder:"请输入邮箱"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title"])}}},me=J(ve,[["__scopeId","data-v-9a1a57a5"]]),pe={class:"user-list-container"},ce={class:"card-header"},fe={class:"pagination-container"},_e={__name:"UserList",setup(O){const x=g(!1),y=g([]),C=g(0),w=g(!1),I=g(null),f=le(),P=g(!1),l=g(!1),v=j({userId:null,newPassword:"",confirmPassword:""}),i=j({page:1,size:10,username:""}),D=r=>{v.userId=r.id,v.newPassword="",v.confirmPassword="",P.value=!0},q=async()=>{if(!v.newPassword){p.error("请输入新密码");return}if(v.newPassword.length<6){p.error("密码长度不能少于6位");return}if(v.newPassword!==v.confirmPassword){p.error("两次输入的密码不一致");return}l.value=!0;try{await ue(v.userId,v.newPassword),p.success("密码重置成功"),P.value=!1}catch(r){p.error(r.message||"密码重置失败")}finally{l.value=!1}},b=async()=>{x.value=!0;try{const r=await oe(i);if(y.value=r.data.records,C.value=r.data.records.length>0?r.data.total:0,f.userInfo){const a=y.value.find(m=>m.id===f.userInfo.id);a&&(a.avatarUrl!==f.userInfo.avatarUrl||a.username!==f.userInfo.username||a.gender!==f.userInfo.gender||a.phone!==f.userInfo.phone||a.email!==f.userInfo.email)&&(f.userInfo={...a},localStorage.setItem("userInfo",JSON.stringify(a)))}}catch(r){p.error(r.message||"获取用户列表失败")}finally{x.value=!1}},B=()=>{i.username="",i.page=1,b()},u=()=>{I.value=null,w.value=!0},s=r=>{I.value={...r},w.value=!0},U=async r=>{try{await ne(r.id),p.success("删除成功"),b()}catch(a){p.error(a.message||"删除失败")}};return re(()=>{b()}),(r,a)=>{const m=d("a-button"),_=d("a-input"),h=d("a-form-item"),L=d("a-space"),A=d("a-form"),R=d("a-avatar"),n=d("a-table-column"),W=d("a-tag"),G=d("a-popconfirm"),H=d("a-table"),K=d("a-pagination"),Q=d("a-card"),F=d("a-input-password"),X=d("a-modal");return k(),N("div",pe,[e(Q,null,{title:t(()=>[E("div",ce,[a[9]||(a[9]=E("span",null,"用户管理",-1)),e(m,{type:"primary",onClick:u},{default:t(()=>[...a[8]||(a[8]=[c("新增用户",-1)])]),_:1})])]),default:t(()=>[e(A,{layout:"inline",model:i,class:"search-form"},{default:t(()=>[e(h,{label:"用户名"},{default:t(()=>[e(_,{value:i.username,"onUpdate:value":a[0]||(a[0]=o=>i.username=o),placeholder:"请输入用户名","allow-clear":""},null,8,["value"])]),_:1}),e(h,null,{default:t(()=>[e(L,null,{default:t(()=>[e(m,{type:"primary",onClick:b},{default:t(()=>[...a[10]||(a[10]=[c("搜索",-1)])]),_:1}),e(m,{onClick:B},{default:t(()=>[...a[11]||(a[11]=[c("重置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),e(H,{dataSource:y.value,loading:x.value,pagination:!1,"row-key":"id"},{default:t(()=>[e(n,{title:"头像",dataIndex:"avatarUrl",width:"80"},{default:t(({record:o})=>[o.avatarUrl?(k(),z(R,{key:0,size:40,src:o.avatarUrl},null,8,["src"])):(k(),z(R,{key:1,size:40},{default:t(()=>{var S,M;return[c(V((M=(S=o.username)==null?void 0:S.charAt(0))==null?void 0:M.toUpperCase()),1)]}),_:2},1024))]),_:1}),e(n,{title:"ID",dataIndex:"id",width:"80"}),e(n,{title:"用户名",dataIndex:"username",width:"120"}),e(n,{title:"账号",dataIndex:"userAccount",width:"120"}),e(n,{title:"性别",dataIndex:"gender",width:"80"},{default:t(({record:o})=>[c(V(o.gender===1?"男":o.gender===2?"女":"未知"),1)]),_:1}),e(n,{title:"电话",dataIndex:"phone",width:"150"}),e(n,{title:"邮箱",dataIndex:"email",width:"200"}),e(n,{title:"角色",dataIndex:"userRole",width:"100"},{default:t(({record:o})=>[e(W,{color:o.userRole==="admin"?"red":"green"},{default:t(()=>[c(V(o.userRole==="admin"?"管理员":"普通用户"),1)]),_:2},1032,["color"])]),_:1}),e(n,{title:"创建时间",dataIndex:"createTime",width:"180"}),e(n,{title:"操作",width:"280"},{default:t(({record:o})=>[e(m,{type:"link",onClick:S=>s(o)},{default:t(()=>[...a[12]||(a[12]=[c("编辑",-1)])]),_:1},8,["onClick"]),e(m,{type:"link",onClick:S=>D(o)},{default:t(()=>[...a[13]||(a[13]=[c("重置密码",-1)])]),_:1},8,["onClick"]),e(G,{title:"确定要删除该用户吗？","ok-text":"确定","cancel-text":"取消",onConfirm:S=>U(o)},{default:t(()=>[e(m,{type:"link",danger:""},{default:t(()=>[...a[14]||(a[14]=[c("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["dataSource","loading"]),E("div",fe,[e(K,{current:i.page,"onUpdate:current":a[1]||(a[1]=o=>i.page=o),"page-size":i.size,"onUpdate:pageSize":a[2]||(a[2]=o=>i.size=o),"page-size-options":["10","20","50","100"],total:C.value,"show-size-changer":"","show-total":"",onChange:b,onShowSizeChange:b},null,8,["current","page-size","total"])])]),_:1}),e(me,{visible:w.value,"onUpdate:visible":a[3]||(a[3]=o=>w.value=o),"user-data":I.value,onSuccess:b},null,8,["visible","user-data"]),e(X,{open:P.value,"onUpdate:open":a[6]||(a[6]=o=>P.value=o),title:"重置密码",onOk:q,"confirm-loading":l.value,onCancel:a[7]||(a[7]=o=>P.value=!1)},{default:t(()=>[e(A,{layout:"vertical"},{default:t(()=>[e(h,{label:"新密码"},{default:t(()=>[e(F,{value:v.newPassword,"onUpdate:value":a[4]||(a[4]=o=>v.newPassword=o),placeholder:"请输入新密码"},null,8,["value"])]),_:1}),e(h,{label:"确认新密码"},{default:t(()=>[e(F,{value:v.confirmPassword,"onUpdate:value":a[5]||(a[5]=o=>v.confirmPassword=o),placeholder:"请再次输入新密码"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["open","confirm-loading"])])}}},be=J(_e,[["__scopeId","data-v-3edec653"]]);export{be as default};
