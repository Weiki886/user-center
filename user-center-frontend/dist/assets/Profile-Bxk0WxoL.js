import{u as D,o as J,c as k,b as a,w as r,j as i,r as n,e as T,f as I,g as R,h as q,P as W,i as c,s as G,a as p,x as H,C as K}from"./index-CrxnEdR7.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as X}from"./LockOutlined-DxT2UMAA.js";const Y={class:"profile-container"},Z={class:"avatar-wrapper"},h=["src"],ee={key:1,class:"avatar-placeholder"},ae={__name:"Profile",setup(le){const S=T(),w=i(null),_=i(!1),v=D(),g=i(!1),P=i(!1),x=i(null),u=i({oldPassword:"",newPassword:"",confirmPassword:""}),l=i({id:"",username:"",userAccount:"",gender:0,phone:"",email:"",avatarUrl:""}),b=i({}),F={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在2-20之间",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}]},M={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:(s,e)=>e!==u.value.newPassword?Promise.reject("两次输入的密码不一致"):Promise.resolve(),trigger:"blur"}]},A=()=>{u.value={oldPassword:"",newPassword:"",confirmPassword:""},g.value=!0},B=async()=>{await x.value.validate(),P.value=!0;try{await K(l.value.id,u.value.oldPassword,u.value.newPassword),g.value=!1,v.logout(),S.push({path:"/login",query:{from:"passwordChanged"}})}catch(s){p.error(s.message||"密码修改失败")}finally{P.value=!1}};J(()=>{v.initUserInfo(),v.userInfo&&(l.value={...v.userInfo},b.value={...v.userInfo})});const L=s=>{const e=s.type.startsWith("image/"),m=s.size/1024/1024<10;if(!e)return p.error("只能上传图片文件!"),!1;if(!m)return p.error("头像大小不能超过 10MB!"),!1;const f=new FileReader;return f.onload=t=>{l.value.avatarUrl=t.target.result},f.readAsDataURL(s),!1},V=async s=>{const{file:e,onSuccess:m,onError:f}=s;try{const t=l.value.id,d=await G(t,e);d.data&&(l.value.avatarUrl=d.data),m(d),p.success("头像上传成功")}catch(t){f(t),p.error(t.message||"头像上传失败")}},N=()=>{var s;l.value={...b.value},(s=w.value)==null||s.clearValidate()},O=async()=>{await w.value.validate(),_.value=!0;try{await H(l.value.id,{username:l.value.username,gender:l.value.gender,phone:l.value.phone,email:l.value.email,avatarUrl:l.value.avatarUrl});const s={...v.userInfo,username:l.value.username,gender:l.value.gender,phone:l.value.phone,email:l.value.email,avatarUrl:l.value.avatarUrl};v.userInfo=s,localStorage.setItem("userInfo",JSON.stringify(s)),b.value={...l.value},p.success("保存成功")}catch(s){p.error(s.message||"保存失败")}finally{_.value=!1}};return(s,e)=>{const m=n("a-button"),f=n("a-upload"),t=n("a-form-item"),d=n("a-input"),U=n("a-radio"),j=n("a-radio-group"),z=n("a-space"),C=n("a-form"),E=n("a-card"),y=n("a-input-password"),$=n("a-modal");return I(),k("div",Y,[a(E,{class:"profile-card"},{title:r(()=>[...e[10]||(e[10]=[R("div",{class:"card-header"},"个人中心",-1)])]),extra:r(()=>[a(m,{type:"link",onClick:A},{default:r(()=>[a(q(X)),e[11]||(e[11]=c(" 修改密码 ",-1))]),_:1})]),default:r(()=>[a(C,{model:l.value,rules:F,ref_key:"formRef",ref:w,layout:"vertical"},{default:r(()=>[a(t,{label:"头像"},{default:r(()=>[R("div",Z,[a(f,{"list-type":"picture-card","show-upload-list":!1,"before-upload":L,"custom-request":V,class:"avatar-uploader"},{default:r(()=>[l.value.avatarUrl?(I(),k("img",{key:0,src:l.value.avatarUrl,class:"avatar-img"},null,8,h)):(I(),k("div",ee,[a(q(W))]))]),_:1})]),e[12]||(e[12]=R("div",{class:"avatar-tip"},"支持 jpg、png 格式，大小不超过 10MB",-1))]),_:1}),a(t,{label:"用户名",name:"username"},{default:r(()=>[a(d,{value:l.value.username,"onUpdate:value":e[0]||(e[0]=o=>l.value.username=o),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),a(t,{label:"账号"},{default:r(()=>[a(d,{value:l.value.userAccount,"onUpdate:value":e[1]||(e[1]=o=>l.value.userAccount=o),disabled:""},null,8,["value"])]),_:1}),a(t,{label:"性别",name:"gender"},{default:r(()=>[a(j,{value:l.value.gender,"onUpdate:value":e[2]||(e[2]=o=>l.value.gender=o)},{default:r(()=>[a(U,{value:0},{default:r(()=>[...e[13]||(e[13]=[c("未知",-1)])]),_:1}),a(U,{value:1},{default:r(()=>[...e[14]||(e[14]=[c("男",-1)])]),_:1}),a(U,{value:2},{default:r(()=>[...e[15]||(e[15]=[c("女",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),a(t,{label:"电话",name:"phone"},{default:r(()=>[a(d,{value:l.value.phone,"onUpdate:value":e[3]||(e[3]=o=>l.value.phone=o),placeholder:"请输入电话号码"},null,8,["value"])]),_:1}),a(t,{label:"邮箱",name:"email"},{default:r(()=>[a(d,{value:l.value.email,"onUpdate:value":e[4]||(e[4]=o=>l.value.email=o),placeholder:"请输入邮箱地址"},null,8,["value"])]),_:1}),a(t,null,{default:r(()=>[a(z,null,{default:r(()=>[a(m,{type:"primary",loading:_.value,onClick:O,size:"large"},{default:r(()=>[...e[16]||(e[16]=[c(" 保存修改 ",-1)])]),_:1},8,["loading"]),a(m,{onClick:N,size:"large"},{default:r(()=>[...e[17]||(e[17]=[c("重置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),a($,{open:g.value,"onUpdate:open":e[8]||(e[8]=o=>g.value=o),title:"修改密码",onOk:B,"confirm-loading":P.value,onCancel:e[9]||(e[9]=o=>g.value=!1)},{default:r(()=>[a(C,{model:u.value,rules:M,ref_key:"passwordFormRef",ref:x,layout:"vertical"},{default:r(()=>[a(t,{label:"旧密码",name:"oldPassword"},{default:r(()=>[a(y,{value:u.value.oldPassword,"onUpdate:value":e[5]||(e[5]=o=>u.value.oldPassword=o),placeholder:"请输入旧密码"},null,8,["value"])]),_:1}),a(t,{label:"新密码",name:"newPassword"},{default:r(()=>[a(y,{value:u.value.newPassword,"onUpdate:value":e[6]||(e[6]=o=>u.value.newPassword=o),placeholder:"请输入新密码"},null,8,["value"])]),_:1}),a(t,{label:"确认新密码",name:"confirmPassword"},{default:r(()=>[a(y,{value:u.value.confirmPassword,"onUpdate:value":e[7]||(e[7]=o=>u.value.confirmPassword=o),placeholder:"请再次输入新密码"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},te=Q(ae,[["__scopeId","data-v-ea49f8fd"]]);export{te as default};
